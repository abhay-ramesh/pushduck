---
title: Server Router
description: Configure your upload routes with type-safe validation and middleware
---

import { Callout } from "fumadocs-ui/components/callout";
import { Tab, Tabs } from "fumadocs-ui/components/tabs";

# Server Router Configuration

The **server router** is the heart of your upload system. It defines upload routes, validation rules, and middleware with full TypeScript inference.

<Callout type="info">
  Every route you define here automatically becomes available on your client
  with complete type safety. No string literals, no runtime errors.
</Callout>

## Basic Router Setup

Start with a simple router configuration:

```typescript
// app/api/s3-upload/route.ts
import { createS3Router, s3 } from "next-s3-uploader/server";

const router = createS3Router({
  // Simple image upload
  profileImage: s3.image(),

  // Document upload with size limit
  documents: s3.file().maxSize("50MB"),

  // Multiple images with custom validation
  gallery: s3
    .image()
    .maxSize("10MB")
    .accept([".jpg", ".png", ".webp"])
    .maxFiles(10),
});

export { router as POST };
export type Router = typeof router;
```

**What you get:**

- ✅ Automatic presigned URL generation
- ✅ File validation before upload
- ✅ Type-safe client integration
- ✅ Built-in error handling

## Schema Builders

Use schema builders to define validation rules with a fluent API:

### Image Schema

```typescript
import { s3 } from "next-s3-uploader/server";

// Basic image upload
const basicImage = s3.image();

// Advanced image upload
const advancedImage = s3
  .image()
  .maxSize("5MB") // File size limit
  .accept([".jpg", ".png", ".webp"]) // Allowed formats
  .dimensions({
    // Image dimensions
    minWidth: 100,
    maxWidth: 2000,
    minHeight: 100,
    maxHeight: 2000,
  })
  .quality(0.8) // JPEG quality (0-1)
  .format("webp"); // Convert to WebP
```

### File Schema

```typescript
// Basic file upload
const basicFile = s3.file();

// Advanced file upload
const advancedFile = s3
  .file()
  .maxSize("100MB")
  .accept([".pdf", ".doc", ".docx"])
  .virus.scan(true) // Enable virus scanning
  .metadata({
    // Custom metadata
    category: "documents",
    department: "hr",
  });
```

### Video Schema

```typescript
// Video upload with processing
const videoUpload = s3
  .video()
  .maxSize("500MB")
  .accept([".mp4", ".mov", ".avi"])
  .duration({ max: 600 }) // Max 10 minutes
  .transcode({
    // Video transcoding
    formats: ["mp4", "webm"],
    resolutions: ["720p", "1080p"],
  });
```

## Advanced Router Configuration

### Custom Paths and Organization

```typescript
const router = createS3Router({
  // User-specific uploads
  userFiles: s3.file().path("users/{userId}/files"),

  // Organization-specific uploads
  orgDocuments: s3.file().path("orgs/{orgId}/documents"),

  // Date-based organization
  dailyReports: s3.file().path("reports/{year}/{month}/{day}"),

  // Custom path generation
  customPath: s3
    .file()
    .path(({ userId, timestamp }) => `custom/${userId}/${timestamp}/files`),
});
```

### Multiple Providers

```typescript
import { createMultiProviderRouter } from "next-s3-uploader/server";

const router = createMultiProviderRouter({
  // Use S3 for images
  images: {
    provider: "s3",
    schema: s3.image().maxSize("10MB"),
  },

  // Use R2 for documents
  documents: {
    provider: "r2",
    schema: s3.file().maxSize("50MB"),
  },

  // Use local storage for development
  temp: {
    provider: process.env.NODE_ENV === "development" ? "local" : "s3",
    schema: s3.file().maxSize("1MB"),
  },
});
```

### Global Configuration

Set default behaviors for all routes:

```typescript
const router = createS3Router(
  {
    // Route definitions...
  },
  {
    // Global configuration
    defaults: {
      maxSize: "10MB",
      path: "uploads/{timestamp}",
      metadata: {
        uploadedBy: "next-s3-uploader",
        version: "2.0",
      },
    },

    // Security settings
    security: {
      requireAuth: true,
      rateLimit: {
        max: 10,
        windowMs: 60000, // 1 minute
      },
      virus: {
        enabled: true,
        provider: "clamav",
      },
    },

    // Processing settings
    processing: {
      image: {
        autoOptimize: true,
        generateThumbnails: ["small", "medium", "large"],
        formats: ["webp", "avif"],
      },
      video: {
        autoTranscode: true,
        generatePreviews: true,
      },
    },
  }
);
```

## Middleware Integration

Add custom logic to your upload pipeline:

### Authentication Middleware

```typescript
import { withAuth } from "@/lib/auth";

const router = createS3Router({
  userFiles: s3
    .file()
    .middleware(withAuth())
    .middleware(async (ctx) => {
      // Custom validation
      if (!ctx.user.canUpload) {
        throw new Error("Upload permission denied");
      }

      // Add user context to path
      ctx.path = `users/${ctx.user.id}/files`;

      return ctx;
    }),
});
```

### Metadata Enhancement

```typescript
const router = createS3Router({
  documents: s3.file().middleware(async (ctx) => {
    // Add custom metadata
    ctx.metadata = {
      ...ctx.metadata,
      uploadedAt: new Date().toISOString(),
      uploadedBy: ctx.user?.id,
      ipAddress: ctx.request.ip,
      userAgent: ctx.request.headers["user-agent"],
    };

    return ctx;
  }),
});
```

### Validation Middleware

```typescript
const router = createS3Router({
  profileImages: s3.image().middleware(async (ctx) => {
    // Custom file validation
    if (ctx.file.name.includes("temp")) {
      throw new Error("Temporary files not allowed");
    }

    // Check file content
    const isValidImage = await validateImageContent(ctx.file);
    if (!isValidImage) {
      throw new Error("Invalid image content");
    }

    return ctx;
  }),
});
```

## Lifecycle Hooks

Hook into the upload lifecycle for custom processing:

```typescript
const router = createS3Router(
  {
    images: s3.image(),
  },
  {
    hooks: {
      beforeUpload: async (ctx) => {
        console.log("Starting upload:", ctx.file.name);

        // Validate against database
        const canUpload = await checkUploadQuota(ctx.user.id);
        if (!canUpload) {
          throw new Error("Upload quota exceeded");
        }
      },

      afterUpload: async (ctx) => {
        console.log("Upload completed:", ctx.result.url);

        // Save to database
        await saveFileRecord({
          userId: ctx.user.id,
          filename: ctx.file.name,
          url: ctx.result.url,
          size: ctx.file.size,
        });

        // Send notification
        await notifyUploadComplete(ctx.user.email, ctx.result);
      },

      onError: async (ctx, error) => {
        console.error("Upload failed:", error);

        // Log error
        await logError({
          userId: ctx.user?.id,
          filename: ctx.file?.name,
          error: error.message,
        });
      },
    },
  }
);
```

## Type Safety Features

### Router Type Export

```typescript
// Export router type for client use
export type AppRouter = typeof router;

// Use in client
import type { AppRouter } from "@/app/api/upload/route";
const upload = createUploadClient<AppRouter>();
```

### Custom Context Types

```typescript
interface CustomContext {
  user: {
    id: string;
    role: "admin" | "user";
    canUpload: boolean;
  };
  organization?: {
    id: string;
    plan: "free" | "pro" | "enterprise";
  };
}

const router = createS3Router<CustomContext>({
  // Your routes with full context typing
});
```

### Validation Schemas

```typescript
import { z } from "zod";

const router = createS3Router({
  documents: s3.file().validate(
    z.object({
      category: z.enum(["invoice", "receipt", "contract"]),
      urgent: z.boolean().optional(),
    })
  ),
});
```

## Environment-Based Configuration

<Tabs items={['Development', 'Staging', 'Production']}>
<Tab value="Development">
```typescript
// config/upload.dev.ts
export const uploadConfig = {
  provider: 'local',
  path: 'uploads/dev',
  maxSize: '50MB',
  security: {
    requireAuth: false,
    rateLimit: false
  },
  processing: {
    enabled: false
  }
}
```
</Tab>
<Tab value="Staging">
```typescript
// config/upload.staging.ts
export const uploadConfig = {
  provider: 's3',
  bucket: 'myapp-staging-uploads',
  path: 'uploads/{environment}',
  maxSize: '25MB',
  security: {
    requireAuth: true,
    rateLimit: {
      max: 20,
      windowMs: 60000
    }
  },
  processing: {
    enabled: true,
    image: {
      autoOptimize: true
    }
  }
}
```
</Tab>
<Tab value="Production">
```typescript
// config/upload.prod.ts
export const uploadConfig = {
  provider: 's3',
  bucket: process.env.AWS_S3_BUCKET_NAME,
  path: 'uploads/{year}/{month}',
  maxSize: '10MB',
  security: {
    requireAuth: true,
    rateLimit: {
      max: 10,
      windowMs: 60000
    },
    virus: {
      enabled: true
    }
  },
  processing: {
    enabled: true,
    image: {
      autoOptimize: true,
      generateThumbnails: true,
      formats: ['webp', 'avif']
    }
  },
  monitoring: {
    enabled: true,
    provider: 'datadog'
  }
}
```
</Tab>
</Tabs>

## Real-World Examples

### E-commerce Product Images

```typescript
const router = createS3Router({
  productImages: s3
    .image()
    .maxSize("5MB")
    .accept([".jpg", ".png", ".webp"])
    .dimensions({ minWidth: 800, minHeight: 600 })
    .path("products/{productId}/images")
    .metadata({ category: "product" })
    .middleware(requireMerchantAuth)
    .processing({
      thumbnails: ["small", "medium", "large"],
      format: "webp",
      quality: 0.85,
    }),
});
```

### Document Management System

```typescript
const router = createS3Router({
  contracts: s3
    .file()
    .accept([".pdf"])
    .maxSize("50MB")
    .path("legal/contracts/{year}")
    .middleware(requireLegalAccess)
    .encrypt(true)
    .retention(7 * 365), // 7 years

  invoices: s3
    .file()
    .accept([".pdf", ".csv", ".xlsx"])
    .maxSize("25MB")
    .path("finance/invoices/{month}")
    .middleware(requireFinanceAccess)
    .audit(true),
});
```

### Social Media Platform

```typescript
const router = createS3Router({
  avatars: s3
    .image()
    .maxSize("2MB")
    .dimensions({ width: 500, height: 500 })
    .path("users/{userId}/avatar")
    .processing({
      crop: "square",
      format: "webp",
      quality: 0.9,
    }),

  posts: s3
    .image()
    .maxSize("10MB")
    .maxFiles(10)
    .path("posts/{postId}/images")
    .middleware(requireAuth)
    .processing({
      thumbnails: ["thumbnail", "medium"],
      watermark: true,
    }),
});
```

## Best Practices

<Callout type="success">
  **Performance**: Use path patterns like `{year}/{month}` to distribute files
  and improve S3 performance.
</Callout>

<Callout type="warn">
  **Security**: Always validate file content, not just extensions. Enable virus
  scanning for production.
</Callout>

<Callout type="info">
  **Cost**: Use lifecycle rules and compression to optimize storage costs.
  Monitor upload patterns.
</Callout>

---

**Next**: Learn how to configure the [client options](/docs/api/configuration/client-options) for your upload components.
