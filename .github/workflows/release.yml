# Release Workflow - Better-Auth Style
# Automatic release creation when tags are pushed

name: Release

on:
  push:
    tags:
      - "*"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  test:
    name: ğŸ›¡ï¸ Test & Safety Checks
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ—ï¸ Setup project
        uses: ./.github/actions/setup

      - name: ğŸ›¡ï¸ Run comprehensive safety check
        run: |
          cd packages/pushduck
          chmod +x scripts/health-check.sh
          ./scripts/health-check.sh

      - name: ğŸ” Run all quality checks
        run: |
          pnpm type-check
          pnpm test:coverage
          pnpm build:packages
          pnpm size-check

  create-release:
    name: ğŸ‰ Create GitHub Release
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: test
    permissions:
      contents: write
      pull-requests: read
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ‰ Create Release with Auto-Generated Notes
        uses: ghalactic/github-release-from-tag@v5
        with:
          generateReleaseNotes: true
          reactions: "+1,heart,rocket"

  publish-npm:
    name: ğŸ“¦ Publish to NPM
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: test
    permissions:
      contents: read
      id-token: write
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup project
        uses: ./.github/actions/setup

      - name: ğŸ“¦ Setup NPM registry
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"
          always-auth: true

      - name: ğŸ—ï¸ Build packages
        run: pnpm build:packages

      - name: ğŸ” Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: ğŸ” Verify NPM_TOKEN
        run: |
          if [ -z "$NPM_TOKEN" ]; then
            echo "âŒ NPM_TOKEN is not set!"
            exit 1
          fi
          echo "âœ… NPM_TOKEN is configured"
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: ğŸ“¤ Publish pushduck
        run: cd packages/pushduck && npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: ğŸ“¤ Publish CLI
        run: cd packages/cli && npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # ğŸ“Š Post-Release Monitoring
  post-release:
    name: ğŸ“Š Post-Release Verification
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [create-release, publish-npm]
    if: always() && needs.publish-npm.result == 'success'

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: âœ… Verify NPM publication
        run: |
          echo "ğŸ” Verifying packages are available on NPM..."

          # Wait for NPM propagation
          sleep 30

          # Get versions from package.json
          MAIN_VERSION=$(node -p "require('./packages/pushduck/package.json').version")
          CLI_VERSION=$(node -p "require('./packages/cli/package.json').version")

          # Check main package
          if npm view "pushduck@$MAIN_VERSION" version; then
            echo "âœ… pushduck@$MAIN_VERSION is live on NPM"
          else
            echo "âŒ pushduck@$MAIN_VERSION not found on NPM"
            exit 1
          fi

          # Check CLI package
          if npm view "@pushduck/cli@$CLI_VERSION" version; then
            echo "âœ… @pushduck/cli@$CLI_VERSION is live on NPM"
          else
            echo "âŒ @pushduck/cli@$CLI_VERSION not found on NPM"
            exit 1
          fi

      - name: ğŸ“± Notify success
        uses: actions/github-script@v7
        with:
          script: |
            const mainVersion = require('./packages/pushduck/package.json').version;
            const cliVersion = require('./packages/cli/package.json').version;

            // Get the tag from the event
            const tag = context.ref.replace('refs/tags/', '');

            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: `## ğŸ‰ Release ${tag} Successful!
              
              âœ… **Packages Published:**
              - \`pushduck@${mainVersion}\`
              - \`@pushduck/cli@${cliVersion}\`
              
              ğŸ“Š **Release Stats:**
              - All quality gates passed âœ…
              - NPM verification successful âœ…
              - GitHub Release created âœ…
              
              ğŸš€ **Ready for use!**
              
              ## ğŸ“¥ Installation
              \`\`\`bash
              npm install pushduck@latest
              # or
              npx @pushduck/cli@latest
              \`\`\``
            });

  # ğŸš¨ Failure Notification
  notify-failure:
    name: ğŸš¨ Release Failure Notification
    runs-on: ubuntu-latest
    needs: [test, create-release, publish-npm, post-release]
    if: always() && (needs.test.result == 'failure' || needs.create-release.result == 'failure' || needs.publish-npm.result == 'failure' || needs.post-release.result == 'failure')

    steps:
      - name: ğŸš¨ Create issue for failed release
        uses: actions/github-script@v7
        with:
          script: |
            const tag = context.ref.replace('refs/tags/', '');
            const title = `ğŸš¨ Release ${tag} Failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `## ğŸš¨ Release Failure Report

            **Tag:** ${tag}
            **Workflow:** ${{ github.workflow }}
            **Run ID:** ${{ github.run_id }}
            **Commit:** ${{ github.sha }}

            **Job Results:**
            - ğŸ›¡ï¸ Test & Safety: ${{ needs.test.result }}
            - ğŸ‰ GitHub Release: ${{ needs.create-release.result }}
            - ğŸ“¦ NPM Publish: ${{ needs.publish-npm.result }}
            - ğŸ“Š Verification: ${{ needs.post-release.result }}

            ## ğŸ” Investigation Steps

            1. Check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            2. Review safety checks and tests
            3. Verify NPM token and permissions
            4. Check package build outputs

            ## ğŸ› ï¸ Manual Recovery

            If automation fails, you can release manually:

            \`\`\`bash
            # 1. Run safety checks
            cd packages/pushduck && ./scripts/health-check.sh

            # 2. Build and publish
            pnpm build:packages
            cd packages/pushduck && npm publish
            cd packages/cli && npm publish

            # 3. Create GitHub release manually
            gh release create ${tag} --generate-notes
            \`\`\`

            ---

            **Auto-generated by GitHub Actions**`;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['bug', 'release', 'automation']
            });
