name: 🚀 Release & Publish

on:
  push:
    branches: [main, master]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # 🔍 Pre-Release Safety Check
  pre-release-check:
    name: 🛡️ Pre-Release Safety Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    outputs:
      should-release: ${{ steps.check.outputs.should-release }}

    steps:
      - name: 🏗️ Setup project
        uses: ./.github/actions/setup

      - name: 🛡️ Run comprehensive safety check
        id: safety
        run: |
          cd packages/pushduck
          chmod +x scripts/health-check.sh
          ./scripts/health-check.sh

      - name: 📝 Validate changesets
        run: |
          cd packages/pushduck
          chmod +x scripts/changeset-validator.js
          node scripts/changeset-validator.js

      - name: 📊 Check if release needed
        id: check
        run: |
          if ls .changeset/*.md 1> /dev/null 2>&1; then
            echo "should-release=true" >> $GITHUB_OUTPUT
            echo "📦 Changesets found - release needed"
          else
            echo "should-release=false" >> $GITHUB_OUTPUT
            echo "ℹ️ No changesets - no release needed"
          fi

  # 🚀 Automated Release
  release:
    name: 🚀 Release to NPM
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: pre-release-check
    if: needs.pre-release-check.outputs.should-release == 'true'

    permissions:
      contents: write
      id-token: write

    steps:
      - name: 🏗️ Setup project
        uses: ./.github/actions/setup

      - name: 📦 Setup NPM registry
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - name: 🏗️ Build packages
        run: pnpm build

      - name: 🔐 Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: 📦 Generate versions & changelogs
        run: |
          pnpm version-packages
          echo "📝 Generated versions and changelogs"

      - name: 📤 Publish to NPM
        run: pnpm release
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: 🏷️ Commit version updates
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            git add .
            git commit -m "chore(release): update versions and changelogs [skip ci]"
            git push
            echo "✅ Committed version updates"
          else
            echo "ℹ️ No changes to commit"
          fi

      - name: 📊 Get release info
        id: release-info
        run: |
          MAIN_VERSION=$(node -p "require('./packages/pushduck/package.json').version")
          CLI_VERSION=$(node -p "require('./packages/cli/package.json').version")
          echo "main-version=$MAIN_VERSION" >> $GITHUB_OUTPUT
          echo "cli-version=$CLI_VERSION" >> $GITHUB_OUTPUT

      - name: 📋 Generate enhanced release notes
        id: release-notes
        run: |
          # Install conventional changelog
          npm install -g conventional-changelog-cli

          # Generate changelog for this release
          conventional-changelog -p angular -t v${{ steps.release-info.outputs.main-version }} > release-notes.md

          # Get bundle sizes
          MAIN_SIZE=$(gzip-size-cli packages/pushduck/dist/index.mjs 2>/dev/null || echo "N/A")
          CLI_SIZE=$(du -sh packages/cli/dist 2>/dev/null | cut -f1 || echo "N/A")

          # Create enhanced release notes
          cat > enhanced-release-notes.md << EOF
          ## 📦 Packages Released

          - \`pushduck@${{ steps.release-info.outputs.main-version }}\`
          - \`@pushduck/cli@${{ steps.release-info.outputs.cli-version }}\`

          ## 📝 What's Changed

          $(cat release-notes.md)

          ## 📊 Bundle Size Report

          | Package | Size (gzipped) | 
          |---------|----------------|
          | pushduck | $MAIN_SIZE |
          | @pushduck/cli | $CLI_SIZE |

          ## 📥 Installation

          \`\`\`bash
          npm install pushduck@latest
          # or
          npx @pushduck/cli@latest
          \`\`\`

          ## 🔗 Links

          - 📚 [Documentation](https://pushduck.vercel.app)
          - 📦 [NPM Package](https://www.npmjs.com/package/pushduck)
          - 🐛 [Report Issues](https://github.com/${{ github.repository }}/issues)
          - 💬 [Discussions](https://github.com/${{ github.repository }}/discussions)

          ---

          **Full Changelog**: https://github.com/${{ github.repository }}/compare/v${{ steps.release-info.outputs.main-version }}...v${{ steps.release-info.outputs.main-version }}
          EOF

          # Set output for GitHub release
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          cat enhanced-release-notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: 🎉 Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.release-info.outputs.main-version }}
          name: 🚀 Release v${{ steps.release-info.outputs.main-version }}
          body: ${{ steps.release-notes.outputs.notes }}
          draft: false
          prerelease: false
          generate_release_notes: true

  # 📊 Post-Release Monitoring - Simplified
  post-release:
    name: 📊 Post-Release Monitoring
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: release
    if: always() && needs.release.result == 'success'

    steps:
      - name: 📥 Checkout (for package.json only)
        uses: actions/checkout@v4

      - name: ✅ Verify NPM publication
        run: |
          echo "🔍 Verifying packages are available on NPM..."

          # Wait a moment for NPM propagation
          sleep 30

          # Check main package
          MAIN_VERSION=$(node -p "require('./packages/pushduck/package.json').version")
          if npm view "pushduck@$MAIN_VERSION" version; then
            echo "✅ pushduck@$MAIN_VERSION is live on NPM"
          else
            echo "❌ pushduck@$MAIN_VERSION not found on NPM"
            exit 1
          fi

          # Check CLI package
          CLI_VERSION=$(node -p "require('./packages/cli/package.json').version")
          if npm view "@pushduck/cli@$CLI_VERSION" version; then
            echo "✅ @pushduck/cli@$CLI_VERSION is live on NPM"
          else
            echo "❌ @pushduck/cli@$CLI_VERSION not found on NPM"
            exit 1
          fi

      - name: 📱 Notify success
        uses: actions/github-script@v7
        with:
          script: |
            const mainVersion = require('./packages/pushduck/package.json').version;
            const cliVersion = require('./packages/cli/package.json').version;

            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: `## 🎉 Release Successful!
              
              ✅ **Packages Published:**
              - \`pushduck@${mainVersion}\`
              - \`@pushduck/cli@${cliVersion}\`
              
              📊 **Release Stats:**
              - Build time: ${{ github.run_id }}
              - All quality gates passed
              - NPM verification successful
              
              🚀 **Ready for use!**`
            });

  # 🚨 Failure Notification
  notify-failure:
    name: 🚨 Release Failure Notification
    runs-on: ubuntu-latest
    needs: [pre-release-check, release]
    if: always() && (needs.pre-release-check.result == 'failure' || needs.release.result == 'failure')

    steps:
      - name: 🚨 Create issue for failed release
        uses: actions/github-script@v7
        with:
          script: |
            const title = `🚨 Release Failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `## 🚨 Release Failure Report

            **Workflow:** ${{ github.workflow }}
            **Run ID:** ${{ github.run_id }}
            **Commit:** ${{ github.sha }}
            **Branch:** ${{ github.ref_name }}

            **Failed Jobs:**
            - Pre-release check: ${{ needs.pre-release-check.result }}
            - Release: ${{ needs.release.result }}

            ## 🔍 Investigation Steps

            1. Check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            2. Review the pre-release safety checks
            3. Verify changeset quality
            4. Check NPM token and permissions

            ## 🛠️ Manual Release Process

            If automation fails, you can release manually:

            \`\`\`bash
            # 1. Run safety checks
            pnpm maintenance:health

            # 2. Generate versions
            pnpm version-packages

            # 3. Publish
            pnpm release
            \`\`\`

            ---

            **Auto-generated by GitHub Actions**`;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['bug', 'release', 'automation']
            });
