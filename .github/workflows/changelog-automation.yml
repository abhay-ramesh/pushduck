name: ğŸ“ Changelog Automation

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize, closed]
  workflow_dispatch:
    inputs:
      version:
        description: "Version to generate changelog for"
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: read

jobs:
  # Validate commit messages on PRs
  validate-commits:
    name: ğŸ” Validate Commit Messages
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ—ï¸ Setup project
        uses: ./.github/actions/setup

      - name: ğŸ“ Install commitlint
        run: npm install -g @commitlint/cli @commitlint/config-conventional

      - name: ğŸ” Validate commit messages
        run: |
          # Validate all commits in the PR
          git log --format="%H %s" origin/${{ github.base_ref }}..HEAD | while read commit; do
            hash=$(echo "$commit" | cut -d' ' -f1)
            message=$(echo "$commit" | cut -d' ' -f2-)
            echo "Validating: $message"
            echo "$message" | commitlint --verbose
          done

      - name: ğŸ’¬ Comment on PR if invalid commits
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âŒ Invalid Commit Messages

              Some commits in this PR don't follow conventional commit format:
              
              **Required format:**
              \`\`\`
              <type>(<scope>): <subject>
              
              - <first point>
              - <second point>
              - <third point>
              \`\`\`

              **Examples:**
              - \`feat(core): add new upload progress indicator\`
              - \`fix(client): resolve memory leak in chunk upload\`
              - \`docs(readme): update installation instructions\`

              **Valid types:** feat, fix, docs, style, refactor, test, chore, perf, ci, build, revert

              Please squash/reword your commits to follow this format.`
            })

  # Generate changelog preview for PRs
  changelog-preview:
    name: ğŸ“‹ Generate Changelog Preview
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ—ï¸ Setup project
        uses: ./.github/actions/setup

      - name: ğŸ“ Install changelog tools
        run: npm install -g conventional-changelog-cli conventional-commits-parser

      - name: ğŸ“‹ Generate changelog preview
        id: changelog
        run: |
          # Generate changelog for commits in this PR
          CHANGELOG=$(conventional-changelog -p angular -u)

          # Escape for GitHub output
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ğŸ’¬ Comment changelog preview
        uses: actions/github-script@v7
        with:
          script: |
            const changelog = `${{ steps.changelog.outputs.changelog }}`;

            if (changelog.trim()) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ğŸ“‹ Changelog Preview

                This PR will generate the following changelog entry:

                \`\`\`markdown
                ${changelog}
                \`\`\`

                **Note:** This is auto-generated from conventional commits. You can still add a manual changeset if needed.`
              });
            }

  # Auto-generate changesets from conventional commits
  auto-changeset:
    name: ğŸ¤– Auto-Generate Changesets
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ—ï¸ Setup project
        uses: ./.github/actions/setup

      - name: ğŸ“ Install tools
        run: npm install -g conventional-commits-parser

      - name: ğŸ¤– Generate changesets from commits
        run: |
          # Get commits since last release
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LAST_TAG" ]; then
            echo "No previous tags found, using all commits"
            COMMITS=$(git log --format="%s" --no-merges)
          else
            echo "Getting commits since $LAST_TAG"
            COMMITS=$(git log ${LAST_TAG}..HEAD --format="%s" --no-merges)
          fi

          # Parse commits and generate changesets
          echo "$COMMITS" | while IFS= read -r commit; do
            if [[ $commit =~ ^(feat|fix|perf|revert)(\([^)]+\))?:(.+)$ ]]; then
              type="${BASH_REMATCH[1]}"
              scope="${BASH_REMATCH[2]}"
              subject="${BASH_REMATCH[3]}"
              
              # Determine version bump type
              case $type in
                feat) bump="minor" ;;
                fix|perf) bump="patch" ;;
                revert) bump="patch" ;;
                *) continue ;;
              esac
              
              # Determine affected packages
              if [[ $scope == *"cli"* ]]; then
                packages='"@pushduck/cli": '$bump''
              elif [[ $scope == *"core"* ]] || [[ $scope == *"client"* ]] || [[ $scope == *"server"* ]]; then
                packages='"pushduck": '$bump''
              else
                packages='"pushduck": '$bump', "@pushduck/cli": '$bump''
              fi
              
              # Create changeset file
              timestamp=$(date +%s)
              changeset_file=".changeset/auto-${timestamp}.md"
              
              cat > "$changeset_file" << EOF
          ---
          $packages
          ---

          $subject
          EOF
              
              echo "Created changeset for: $commit"
            fi
          done

      - name: ğŸ“¦ Commit auto-generated changesets
        run: |
          if [ -n "$(git status --porcelain .changeset/)" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            
            git add .changeset/
            git commit -m "chore: add auto-generated changesets [skip ci]"
            git push
            
            echo "âœ… Auto-generated changesets committed"
          else
            echo "â„¹ï¸ No changesets to commit"
          fi

  # Enhanced release notes generation
  enhanced-release-notes:
    name: ğŸ‰ Generate Enhanced Release Notes
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ—ï¸ Setup project
        uses: ./.github/actions/setup

      - name: ğŸ“ Install tools
        run: npm install -g conventional-changelog-cli

      - name: ğŸ‰ Generate enhanced release notes
        run: |
          VERSION="${{ inputs.version }}"
          if [ -z "$VERSION" ]; then
            VERSION=$(node -p "require('./packages/pushduck/package.json').version")
          fi

          echo "# Release Notes for v$VERSION" > release-notes.md
          echo "" >> release-notes.md

          # Generate conventional changelog
          conventional-changelog -p angular -i release-notes.md -s

          # Add additional sections
          cat >> release-notes.md << EOF

          ## ğŸ“Š Bundle Size Report

          | Package | Size (gzipped) | Change |
          |---------|----------------|--------|
          | pushduck | $(gzip-size-cli packages/pushduck/dist/index.mjs) | - |
          | @pushduck/cli | $(du -sh packages/cli/dist | cut -f1) | - |

          ## ğŸ”— Links

          - ğŸ“š [Documentation](https://pushduck.vercel.app)
          - ğŸ“¦ [NPM Package](https://www.npmjs.com/package/pushduck)
          - ğŸ› [Report Issues](https://github.com/abhay-ramesh/pushduck/issues)
          - ğŸ’¬ [Discussions](https://github.com/abhay-ramesh/pushduck/discussions)

          ## ğŸ™ Contributors

          Thanks to all contributors who made this release possible!
          EOF

          echo "Enhanced release notes generated:"
          cat release-notes.md

      - name: ğŸ“¤ Upload release notes
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: release-notes.md
